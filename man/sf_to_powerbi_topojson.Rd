% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/sf_to_powerbi_topojson.R
\name{sf_to_powerbi_topojson}
\alias{sf_to_powerbi_topojson}
\title{Convert SF Object to Power BI-Compatible TopoJSON}
\usage{
sf_to_powerbi_topojson(
  sf_data,
  file = "output_powerbi.json",
  object_name = "features",
  id_col = NULL,
  name_col = NULL,
  keep_cols = NULL,
  simplify = FALSE,
  tolerance = 0.01,
  verbose = TRUE
)
}
\arguments{
\item{sf_data}{sf object. Spatial data to convert. Must contain POLYGON or
MULTIPOLYGON geometries. Required.}

\item{file}{Character string. Output file path. Must end with .json extension
(Power BI requirement). Default is "output_powerbi.json".}

\item{object_name}{Character string. Name for the TopoJSON object layer. This
name will be used by Power BI to identify the geographic layer. Default is
"features".}

\item{id_col}{Character string or NULL. Optional column name to use as the
feature ID in the TopoJSON properties. If specified, this field should
uniquely identify each feature. Default is NULL (no specific ID field).}

\item{name_col}{Character string or NULL. Optional column name to use as the
feature name in the TopoJSON properties. Useful for labeling features in
Power BI. Default is NULL (no specific name field).}

\item{keep_cols}{Character vector or NULL. Column names to keep in the output
properties (excluding geometry). If NULL (default), all attribute columns
are kept. Geometry column is always retained.}

\item{simplify}{Logical. If TRUE, simplify geometries using rmapshaper to
reduce file size while preserving topology. Requires rmapshaper package.
Default is FALSE.}

\item{tolerance}{Numeric. Simplification tolerance parameter for
\code{rmapshaper::ms_simplify} (0-1). Higher values = more simplification.
This is the "keep" parameter: proportion of points to retain. Only used if
simplify = TRUE. Default is 0.01 (keep 1% of points).}

\item{verbose}{Logical. If TRUE (default), print progress messages including
CRS transformations, simplification results, and file creation.}
}
\value{
Invisibly returns the output file path. The function is called
  primarily for its side effect of creating the TopoJSON file.
}
\description{
Converts an sf spatial dataframe to TopoJSON format optimized for Microsoft
Power BI Shape Map visualizations. Automatically handles CRS transformation
to WGS84 and validates geometry types.
}
\details{
\strong{Power BI Requirements:}
Power BI Shape Map visual has specific requirements for custom map files:
\itemize{
  \item \strong{CRS}: Must use WGS84 (EPSG:4326) coordinate system
  \item \strong{Geometry}: Only POLYGON and MULTIPOLYGON supported (no lines/points)
  \item \strong{File Extension}: Must be .json (not .topojson)
  \item \strong{Properties}: Need feature properties for data binding
}

This function automatically handles all these requirements:
\enumerate{
  \item Validates that geometries are polygon types
  \item Transforms to WGS84 if needed
  \item Ensures .json file extension
  \item Preserves attribute columns for data binding
}

\strong{Column Filtering:}
You can control which attribute columns are included using \code{keep_cols},
\code{id_col}, and \code{name_col}:
\itemize{
  \item If \code{keep_cols} is NULL: all columns are kept
  \item If \code{keep_cols} is specified: only those columns (plus geometry)
  \item If \code{id_col} or \code{name_col} are specified and not in
    \code{keep_cols}, they are automatically added
}

\strong{Simplification:}
Setting \code{simplify = TRUE} can dramatically reduce file size for complex
geometries (e.g., detailed municipality boundaries). The \code{tolerance}
parameter controls how much simplification occurs:
\itemize{
  \item 0.01 = keep 1% of points (aggressive simplification)
  \item 0.1 = keep 10% of points (moderate simplification)
  \item 0.5 = keep 50% of points (gentle simplification)
}

Requires the rmapshaper package. Simplification uses topology-preserving
algorithms that maintain shared boundaries between adjacent polygons.

\strong{Using in Power BI:}
Once you have created the .json file:
\enumerate{
  \item Open Power BI Desktop
  \item Insert > Shape Map visual
  \item Click on the visual
  \item Format visual > Shape > Map settings
  \item Click "+ Add map" and select your .json file
  \item Drag your data fields to the visual:
    \itemize{
      \item Location: field matching \code{id_col} or other identifier
      \item Color saturation: your metric field
      \item Tooltips: additional fields to display
    }
}

\strong{Export Methods:}
The function uses two methods to create TopoJSON:
\enumerate{
  \item Primary: \code{geojsonio::topojson_write()} - direct conversion
  \item Fallback: \code{sf::st_write()} to GeoJSON, then
    \code{geojsonio::geo2topo()} - used if primary method fails
}
}
\examples{
\dontrun{
# Basic usage with default settings
library(sf)
italy_regions <- st_read("regions.shp")
sf_to_powerbi_topojson(italy_regions, file = "italy_regions.json")

# Specify ID and name columns for Power BI matching
sf_to_powerbi_topojson(
  sf_data = italy_regions,
  file = "italy_regions.json",
  id_col = "COD_REG",
  name_col = "DEN_REG",
  object_name = "regioni"
)

# Keep only specific columns and simplify geometries
sf_to_powerbi_topojson(
  sf_data = italy_municipalities,
  file = "italy_comuni_simple.json",
  keep_cols = c("PRO_COM", "COMUNE", "COD_REG"),
  simplify = TRUE,
  tolerance = 0.01  # Keep 1\% of points
)

# With aggressive simplification for large datasets
sf_to_powerbi_topojson(
  sf_data = detailed_boundaries,
  file = "boundaries_simplified.json",
  simplify = TRUE,
  tolerance = 0.005,  # Very aggressive
  verbose = TRUE  # See size reduction
)

# Use with situas package data
library(situas)
files <- prepare_territorial_maps(territorial_level = "province")
province_sf <- readRDS(files$rds)

# Convert to custom Power BI format with specific columns
sf_to_powerbi_topojson(
  sf_data = province_sf,
  file = "data/province_custom.json",
  id_col = "COD_UTS",
  name_col = "DEN_UTS",
  keep_cols = c("COD_UTS", "DEN_UTS", "COD_REG"),
  object_name = "province"
)
}
}
