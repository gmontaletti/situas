% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/prepare_comuni_maps.R
\name{prepare_comuni_maps}
\alias{prepare_comuni_maps}
\title{Prepare Geographic Maps of Italian Territorial Units}
\usage{
prepare_comuni_maps(
  situas_data = NULL,
  pfun = NULL,
  output_dir = "data",
  date = Sys.Date(),
  simplify = TRUE,
  tolerance = 0.001,
  keep_attributes = c("PRO_COM", "PRO_COM_T", "COMUNE", "COD_REG", "DEN_REG", "COD_UTS",
    "DEN_UTS", "SIGLA_AUTOMOBILISTICA"),
  verbose = TRUE
)
}
\arguments{
\item{situas_data}{data.table. SITUAS data to join with shapefile. If provided,
this data will be used instead of downloading from the API. Must contain at
least a \code{PRO_COM} column for joining. Default is NULL (download from API).}

\item{pfun}{Integer or NULL. SITUAS report ID to download. Only used if
\code{situas_data} is NULL. If both \code{situas_data} and \code{pfun} are
NULL, defaults to 61 (municipalities). Also used for file naming. Common values:
\itemize{
  \item \strong{61}: Current municipalities - Elenco comuni
  \item \strong{64}: Provinces/UTS - Elenco Province/Uts
  \item \strong{68}: Regions - Elenco Regioni
  \item \strong{73}: Municipality characteristics - Comuni caratteristiche
}
Use \code{search_reports()} to find other available reports.}

\item{output_dir}{Character string. Directory where output files will be saved.
Defaults to "data". Directory will be created if it doesn't exist.}

\item{date}{Date, POSIXct, or character string. Reference date for SITUAS data.
Only used if \code{situas_data} is NULL and data is downloaded from API.
Defaults to current date. The date determines which territorial configuration
is returned (as territories change over time).}

\item{simplify}{Logical. If TRUE (default), simplify geometries to reduce file
size while preserving topology. Recommended for web mapping and dashboards.}

\item{tolerance}{Numeric. Simplification tolerance (in map units, degrees for
WGS84). Default is 0.001. Higher values = more simplification. Only used if
simplify = TRUE and rmapshaper package is installed.}

\item{keep_attributes}{Character vector. Attributes to keep in the output.
Defaults to common municipality attributes. Set to NULL to keep all attributes
from the SITUAS report. Adjust based on your chosen report.}

\item{verbose}{Logical. If TRUE (default), print progress messages.}
}
\value{
Invisibly returns a list with paths to the created files:
  \describe{
    \item{rds}{Path to RDS file (merged R sf object with SITUAS attributes)}
    \item{geojson}{Path to GeoJSON file (for Leaflet/web mapping)}
    \item{topojson}{Path to TopoJSON file (for Power BI)}
    \item{shapefile_rds}{Path to RDS file (original sf shapefile before merge)}
    \item{situas_rds}{Path to RDS file (SITUAS data table before merge)}
  }
}
\description{
Creates map-ready files by joining SITUAS data with ISTAT shapefiles.
Exports multiple formats for R dashboards (RDS, GeoJSON) and Power BI (TopoJSON).
Works with municipalities, provinces, and regions.
}
\details{
\strong{Input Data:}
\itemize{
  \item Shapefile: \code{data-raw/Limiti01012025_g.zip} containing municipality
    boundaries in WGS84 projection
  \item SITUAS data: Report 61 with current municipality codes and names
}

\strong{Join Key:}
Data is joined on \code{PRO_COM} code, which uniquely identifies each municipality.

\strong{Output Files:}
\itemize{
  \item \strong{RDS (merged)}: Fast loading in R, preserves merged sf object with
    SITUAS attributes. Best for R dashboards and analysis.
  \item \strong{GeoJSON}: Web standard, works with Leaflet and most mapping
    libraries. Human-readable format.
  \item \strong{TopoJSON}: Microsoft Power BI standard for Shape Map visual.
    More compact than GeoJSON.
  \item \strong{Shapefile RDS}: Original sf shapefile with geometries only
    (before merge with SITUAS). Useful for custom joins.
  \item \strong{SITUAS RDS}: SITUAS data table (before merge). Useful for
    separate attribute analysis.
}

\strong{File Sizes (approximate):}
\itemize{
  \item Original shapefile: ~12 MB
  \item Simplified (tolerance=0.001): ~1-2 MB
  \item TopoJSON: ~0.5-1 MB (most compact)
}

\strong{Using in Power BI:}
\enumerate{
  \item Open Power BI Desktop
  \item Insert > Shape Map visual
  \item Click on the visual, then Format > Shape > Map settings
  \item Click "+ Add map" and select the .json (TopoJSON) file
  \item Map your data using PRO_COM or COMUNE field
}
}
\note{
This function is now a wrapper around \code{\link{prepare_territorial_maps}}.
  For working with provinces, regions, or geographic partitions, use
  \code{\link{prepare_territorial_maps}} directly with the appropriate
  \code{territorial_level} parameter.
}
\section{Setup}{

For better performance, extract the shapefile once before first use:
\code{source("data-raw/extract_shapefiles.R")}

If not pre-extracted, the shapefile will be extracted to a temporary directory
each time this function is called (slower but still works).
}

\examples{
\dontrun{
# Basic usage - municipalities (default)
files <- prepare_comuni_maps()

# Pass pre-downloaded SITUAS data (recommended for custom workflows)
comuni_data <- get_situas_tables(pfun = 61, date = "2025-01-01")
files <- prepare_comuni_maps(situas_data = comuni_data)

# Provinces/UTS - download automatically
files <- prepare_comuni_maps(
  pfun = 64,
  keep_attributes = c("COD_UTS", "DEN_UTS", "COD_REG", "DEN_REG")
)

# Regions - using pre-downloaded data
regioni_data <- get_situas_tables(pfun = 68)
files <- prepare_comuni_maps(
  situas_data = regioni_data,
  keep_attributes = c("COD_REG", "DEN_REG")
)

# Use in Leaflet
library(leaflet)
comuni_sf <- readRDS(files$rds)
leaflet(comuni_sf) \%>\%
  addTiles() \%>\%
  addPolygons(popup = ~COMUNE)

# Create maps for a specific date (auto-download)
files <- prepare_comuni_maps(pfun = 61, date = "2020-01-01")

# No simplification (larger files, more detail)
files <- prepare_comuni_maps(simplify = FALSE)

# Keep all attributes from SITUAS
files <- prepare_comuni_maps(keep_attributes = NULL)

# Find available reports
reports <- search_reports()
print(reports[, .(pfun, title, analysis_type)])
}
}
