% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/prepare_territorial_maps.R
\name{prepare_territorial_maps}
\alias{prepare_territorial_maps}
\title{Prepare Geographic Maps of Italian Territorial Units}
\usage{
prepare_territorial_maps(
  situas_data = NULL,
  pfun = NULL,
  territorial_level = "comuni",
  output_dir = "data",
  date = Sys.Date(),
  simplify = TRUE,
  tolerance = 0.001,
  keep_attributes = NULL,
  verbose = TRUE
)
}
\arguments{
\item{situas_data}{data.table. SITUAS data to join with shapefile. If provided,
this data will be used instead of downloading from the API. Must contain at
least the appropriate join field for the territorial level. Default is NULL
(download from API).}

\item{pfun}{Integer or NULL. SITUAS report ID to download. Only used if
\code{situas_data} is NULL. If both \code{situas_data} and \code{pfun} are
NULL, defaults based on \code{territorial_level}. Also used for file naming.
Common values:
\itemize{
  \item \strong{61}: Current municipalities - Elenco comuni (default for "comuni")
  \item \strong{64}: Provinces/UTS - Elenco Province/Uts (default for "province")
  \item \strong{68}: Regions - Elenco Regioni (default for "regioni")
  \item \strong{71}: Geographic partitions - Ripartizioni geografiche (default for "ripartizioni")
}
Use \code{search_reports()} to find other available reports.}

\item{territorial_level}{Character string. Level of territorial unit to map.
Must be one of: "comuni" (municipalities), "province" (provinces/metropolitan
cities), "regioni" (regions), or "ripartizioni" (geographic partitions).
Default is "comuni".}

\item{output_dir}{Character string. Directory where output files will be saved.
Defaults to "data". Directory will be created if it doesn't exist.}

\item{date}{Date, POSIXct, or character string. Reference date for SITUAS data.
Only used if \code{situas_data} is NULL and data is downloaded from API.
Defaults to current date. The date determines which territorial configuration
is returned (as territories change over time).}

\item{simplify}{Logical. If TRUE (default), simplify geometries to reduce file
size while preserving topology. Recommended for web mapping and dashboards.}

\item{tolerance}{Numeric. Simplification tolerance (in map units, degrees for
WGS84). Default is 0.001. Higher values = more simplification. Only used if
simplify = TRUE and rmapshaper package is installed.}

\item{keep_attributes}{Character vector. Attributes to keep in the output.
Defaults to NULL (keep all attributes from SITUAS report). Set to a character
vector to filter specific attributes. Adjust based on your chosen report and
territorial level.}

\item{verbose}{Logical. If TRUE (default), print progress messages.}
}
\value{
Invisibly returns a list with paths to the created files:
  \describe{
    \item{rds}{Path to RDS file (merged R sf object with SITUAS attributes)}
    \item{geojson}{Path to GeoJSON file (for Leaflet/web mapping)}
    \item{topojson}{Path to TopoJSON file (for Power BI)}
    \item{shapefile_rds}{Path to RDS file (original sf shapefile before merge)}
    \item{situas_rds}{Path to RDS file (SITUAS data table before merge)}
  }
}
\description{
Creates map-ready files by joining SITUAS data with ISTAT shapefiles for any
territorial level. Exports multiple formats for R dashboards (RDS, GeoJSON)
and Power BI (TopoJSON). Supports municipalities, provinces, regions, and
geographic partitions.
}
\details{
\strong{Input Data:}
\itemize{
  \item Shapefile: \code{data-raw/Limiti01012025_g.zip} containing territorial
    boundaries in WGS84 projection for all levels
  \item SITUAS data: Appropriate report based on \code{pfun} or \code{territorial_level}
}

\strong{Join Keys by Territorial Level:}
\itemize{
  \item \strong{comuni}: PRO_COM - Province-municipality code (6 digits)
  \item \strong{province}: COD_UTS - Province/UTS code (3 digits)
  \item \strong{regioni}: COD_REG - Region code (2 digits)
  \item \strong{ripartizioni}: COD_RIP - Geographic partition code (1 digit)
}

\strong{Output Files:}
\itemize{
  \item \strong{RDS (merged)}: Fast loading in R, preserves merged sf object with
    SITUAS attributes. Best for R dashboards and analysis.
  \item \strong{GeoJSON}: Web standard, works with Leaflet and most mapping
    libraries. Human-readable format.
  \item \strong{TopoJSON}: Microsoft Power BI standard for Shape Map visual.
    More compact than GeoJSON.
  \item \strong{Shapefile RDS}: Original sf shapefile with geometries only
    (before merge with SITUAS). Useful for custom joins.
  \item \strong{SITUAS RDS}: SITUAS data table (before merge). Useful for
    separate attribute analysis.
}

\strong{File Sizes (approximate):}
\itemize{
  \item Comuni original: ~12 MB, simplified: ~1-2 MB
  \item Province original: ~2 MB, simplified: ~0.5 MB
  \item Regioni original: ~1 MB, simplified: ~0.3 MB
  \item Ripartizioni original: ~0.5 MB, simplified: ~0.2 MB
  \item TopoJSON is typically most compact
}

\strong{Using in Power BI:}
\enumerate{
  \item Open Power BI Desktop
  \item Insert > Shape Map visual
  \item Click on the visual, then Format > Shape > Map settings
  \item Click "+ Add map" and select the .json (TopoJSON) file
  \item Map your data using the appropriate join field
}
}
\section{Setup}{

For better performance, extract the shapefile once before first use:
\code{source("data-raw/extract_shapefiles.R")}

If not pre-extracted, the shapefile will be extracted to a temporary directory
each time this function is called (slower but still works).
}

\examples{
\dontrun{
# 1. MUNICIPALITIES (default)
files <- prepare_territorial_maps()
# or explicitly
files <- prepare_territorial_maps(territorial_level = "comuni")

# 2. PROVINCES
files <- prepare_territorial_maps(
  territorial_level = "province",
  keep_attributes = c("COD_UTS", "DEN_UTS", "COD_REG", "DEN_REG")
)

# 3. REGIONS
files <- prepare_territorial_maps(
  territorial_level = "regioni",
  keep_attributes = c("COD_REG", "DEN_REG")
)

# 4. GEOGRAPHIC PARTITIONS
files <- prepare_territorial_maps(
  territorial_level = "ripartizioni",
  keep_attributes = c("COD_RIP", "DEN_RIP")
)

# Pass pre-downloaded SITUAS data (recommended for custom workflows)
regioni_data <- get_situas_tables(pfun = 68, date = "2025-01-01")
files <- prepare_territorial_maps(
  situas_data = regioni_data,
  territorial_level = "regioni"
)

# Use in Leaflet
library(leaflet)
map_sf <- readRDS(files$rds)
leaflet(map_sf) \%>\%
  addTiles() \%>\%
  addPolygons(popup = ~DEN_REG)  # or ~COMUNE, ~DEN_UTS, etc.

# Create maps for a specific date (auto-download)
files <- prepare_territorial_maps(
  territorial_level = "comuni",
  date = "2020-01-01"
)

# No simplification (larger files, more detail)
files <- prepare_territorial_maps(
  territorial_level = "province",
  simplify = FALSE
)

# Custom report with specific pfun
files <- prepare_territorial_maps(
  pfun = 73,  # Municipality characteristics
  territorial_level = "comuni",
  keep_attributes = NULL  # Keep all attributes
)

# Find available reports
reports <- search_reports()
print(reports[, .(pfun, title, analysis_type)])
}
}
